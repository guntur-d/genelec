this is the loginform.js and [[...all]].js

import m from "mithril"

console.log('login fire')

import { getFingerprint } from "../../lib/fingerprint.js"

const i18n = {
  en: {
    heading: "Log In",
    subheading: "Welcome back! Please sign in.",
    email: "Email",
    password: "Password",
    login: "Log In",
    error: "Login failed. Please check your credentials.",
    forgotPassword: "Forgot your password?",
    reset: {
      heading: "Reset Your Password",
      subheading: "Enter your email and we'll send you reset instructions.",
      email: "Registered Email",
      button: "Send Reset Link",
      success: "Reset link sent! Please check your email.",
      error: "Could not send reset email. Try again.",
    },
  },
  id: {
    heading: "Masuk",
    subheading: "Selamat datang! Silakan masuk.",
    email: "Surel",
    password: "Kata Sandi",
    login: "Masuk",
    error: "Login gagal. Silakan periksa kembali kredensial Anda.",
    forgotPassword: "Lupa kata sandi?",
    reset: {
      heading: "Atur Ulang Kata Sandi",
      subheading: "Masukkan email Anda dan kami akan mengirimkan instruksi.",
      email: "Email Terdaftar",
      button: "Kirim Tautan Atur Ulang",
      success: "Tautan atur ulang dikirim! Silakan periksa email Anda.",
      error: "Gagal mengirim email atur ulang. Coba lagi.",
    },
  },
}

const LoginForm = {


  email: "",
  password: "",
  error: "",
  success: "",
  loading: false, // ⏳ Track whether request is in progress
  forgotEmail: "",
  resetSuccess: false,
  resetError: "",
  showResetModal: false,
  resetLoading: false,
  resetStep: 1, // 1: email, 2: code
  resetCode: "",
  serverCode: "", // store code from backend (for demo, in real app, validate on backend)


  view: () => {

    document.documentElement.setAttribute("data-theme", localStorage.getItem("theme") || "auto")
    const lang = localStorage.getItem("lang") || "en"
    const t = i18n[lang]


    return m("main.container", [
      m("article", [
        m("hgroup", [
          m("h1", t.heading),
          m("h2", t.subheading),
        ]),

        LoginForm.error && m("p", { style: "color: red;" }, `❌ ${t.error}`),
        LoginForm.success && m("p", { style: "color: green;" }, "✅ Login successful"),

        m("form", {
          onsubmit: async (e) => {
            e.preventDefault()
            LoginForm.error = LoginForm.success = ""
            LoginForm.loading = true

            try {
              const res = await m.request({
                method: "POST",
                url: "/api/login",
                body: {
                  email: LoginForm.email,
                  password: LoginForm.password,
                  fingerprint: await getFingerprint()
                },
              })

              LoginForm.success = res.msg || "Logged in"
              localStorage.setItem("token", res.token)
              m.route.set("/")
            } catch (err) {
              LoginForm.error = err.message || "Login failed"
              if (err.status === 401) LoginForm.error = t.error
            }

            LoginForm.loading = false
          },
        }, [
          m("label", { for: "email" }, t.email),
          m("input", {
            id: "email",
            type: "email",
            placeholder: "you@example.com",
            value: LoginForm.email,
            oninput: (e) => (LoginForm.email = e.target.value),
          }),

          m("label", { for: "password" }, t.password),
          m("input", {
            id: "password",
            type: "password",
            placeholder: "••••••••",
            value: LoginForm.password,
            oninput: (e) => (LoginForm.password = e.target.value),
          }),

          m("button", {
            type: "submit",
            //  value:  t.login,
            //  value: LoginForm.loading ? "⏳ " + t.login : t.login,
            'aria-busy': LoginForm.loading ? "true" : false,
            disabled: !(LoginForm.email && LoginForm.password),
          }, t.login),
        ]), m("a", {
          style: "margin-top: 0.5rem; text-decoration: underline; cursor: pointer; display: inline-block;",
          onclick: () => {
            LoginForm.resetSuccess = LoginForm.resetError = ""
            LoginForm.forgotEmail = LoginForm.email // preload if already typed
            LoginForm.showResetModal = true
          }
        }, lang === "id" ? "🔑 Lupa kata sandi?" : "🔑 Forgot your password?"),
      ]),
    ],
 LoginForm.showResetModal &&
    m("dialog[open]", {
      style: "max-width: 400px; margin: auto; border-radius: 6px;"
    }, [
      m("article", [
        m("header", [
          m("h3", lang === "id" ? "Lupa Kata Sandi" : "Forgot Password"),
        ]),
        m("p", lang === "id"
          ? "Masukkan email yang terdaftar untuk menerima kode reset."
          : "Enter your registered email to receive a reset code."
        ),
        // Step 1: Email input
        LoginForm.resetStep === 1 && [
          LoginForm.resetSuccess && m("p", { style: "color: green" },
            lang === "id" ? "✅ Kode berhasil dikirim. Silakan cek email Anda." : "✅ Code sent successfully. Please check your email."
          ),
          LoginForm.resetError && m("p", { style: "color: red" },
            lang === "id" ? "❌ Gagal mengirim tautan reset" : "❌ Failed to send reset email"
          ),
          m("form", {
            onsubmit: async (e) => {
              e.preventDefault()
              LoginForm.resetSuccess = LoginForm.resetError = ""
              LoginForm.resetLoading = true
              try {
                const res = await m.request({
                  method: "POST",
                  url: "/api/request-password-reset",
                  body: { email: LoginForm.forgotEmail },
                  headers: { "x-lang": lang }
                })
                LoginForm.resetSuccess = true
                LoginForm.serverCode = res.code // <-- get code from backend (for demo)
                LoginForm.resetStep = 2
              } catch (err) {
                LoginForm.resetError = true
              }
              LoginForm.resetLoading = false
            }
          }, [
            m("label", { for: "forgotEmail" }, lang === "id" ? "Email Terdaftar" : "Registered Email"),
            m("input", {
              id: "forgotEmail",
              type: "email",
              value: LoginForm.forgotEmail,
              oninput: e => LoginForm.forgotEmail = e.target.value
            }),
            m("div", { style: "display: flex; gap: 0.5rem; margin-top: 1rem;" }, [
              m("button", {
                style : {"border-color":"#D93526", "background-color":"#D93526"},
                type: "button",
                onclick: () => {
                  LoginForm.showResetModal = false
                  LoginForm.resetStep = 1
                  LoginForm.resetSuccess = LoginForm.resetError = ""
                  LoginForm.forgotEmail = ""
                  LoginForm.resetCode = ""
                }
              }, lang === "id" ? "Batal" : "Cancel"),
              m("button", {
                type: "submit",
                disabled: !LoginForm.forgotEmail || LoginForm.resetLoading
              }, LoginForm.resetLoading ? (lang === "id" ? "Mengirim..." : "Sending...") : (lang === "id" ? "Kirim Kode" : "Send Code"))
            ])
          ])
        ],
        // Step 2: Code input
        LoginForm.resetStep === 2 && [
          m("form", {
            onsubmit: (e) => {
              e.preventDefault()
              // For demo: compare with serverCode, in real app, validate on backend
              if (LoginForm.resetCode === LoginForm.serverCode) {
                // Redirect to /reset/?code=xxxxxx&email=...
                window.location.href = `/reset/?code=${encodeURIComponent(LoginForm.resetCode)}&email=${encodeURIComponent(LoginForm.forgotEmail)}`
              } else {
                LoginForm.resetError = true
              }
            }
          }, [
            m("label", { for: "resetCode" }, lang === "id" ? "Kode 6 Digit" : "6 Digit Code"),
            m("input", {
              id: "resetCode",
              type: "text",
              maxlength: 6,
              pattern: "\\d{6}",
              value: LoginForm.resetCode,
              oninput: e => {
                LoginForm.resetCode = e.target.value.replace(/\D/g, "").slice(0, 6)
                LoginForm.resetError = false
              }
            }),
            LoginForm.resetError && m("p", { style: "color: red" },
              lang === "id" ? "❌ Kode salah" : "❌ Incorrect code"
            ),
            m("div", { style: "display: flex; gap: 0.5rem; margin-top: 1rem;" }, [
              m("button.secondary", {
                type: "button",
                onclick: () => {
                  LoginForm.resetStep = 1
                  LoginForm.resetCode = ""
                  LoginForm.resetError = false
                }
              }, lang === "id" ? "Kembali" : "Back"),
              m("button", {
                type: "submit",
                disabled: LoginForm.resetCode.length !== 6
              }, lang === "id" ? "Konfirmasi" : "Confirm")
            ])
          ])
        ]
      ])
    ]))
  },
}

export default LoginForm

// api/[[...all]].js
import Fastify from "fastify"
import FastifyJwt from "@fastify/jwt"
import bcrypt from "bcrypt"

import { config as loadEnv } from "dotenv"
 console.log("Loading environment variables...")

// Load .env locally
if (!process.env.VERCEL) loadEnv()

  
  console.log("Connecting to:", process.env.MONGODB_URI)

import mongoose from "mongoose"
import User from "../models/User.js"
import nodemailer from "nodemailer"
 
let isConnected = false

export async function connectDB() {
  if (isConnected) return

  await mongoose.connect(process.env.MONGODB_URI, {
    dbName: "genelec",
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })

  isConnected = true
  console.log("[Mongoose] Connected ✅")
}


// --- Fastify setup ---
const app = Fastify({ logger: true })
app.register(FastifyJwt, {
  secret: process.env.JWT_SECRET,
  // Custom function to extract token from header (optional):
  decode: (req) => {
    const auth = req.headers.authorization
    if (!auth || !auth.startsWith("Bearer ")) return null
    return auth.slice(7)
  }
})

app.decorate("authenticate", async (req, reply) => {
  try {
    await req.jwtVerify()

    const tokenFp = req.user.fingerprint
    const headerFp = req.headers["x-device-fingerprint"]

    console.log("Decoded token:", req.user)
    console.log("Device fingerprint from header:", headerFp)

    if (!tokenFp || !headerFp || tokenFp !== headerFp) {
      console.warn("⚠️ Fingerprint mismatch")
      return reply.code(403).send({ error: "Access denied: device mismatch" })
    }
  } catch (err) {
    console.error("❌ Auth error:", err)
    return reply.code(401).send({ error: "Invalid or missing token" })
  }
})

// --- Routes ---

app.post("/api/login", async (req, reply) => {
  console.log("🔐 Login route triggered")

  await connectDB()

  const { email, password, fingerprint } = req.body || {}

  if (!email || !password || !fingerprint) {
    return reply.code(400).send({ error: "Email, password, and fingerprint required" })
  }

  const user = await User.findOne({ email })
  if (!user) {
    return reply.code(401).send({ error: "Invalid email or password" })
  }

  const isMatch = await bcrypt.compare(password, user.hash)
  if (!isMatch) {
    return reply.code(401).send({ error: "Invalid email or password" })
  }

  // Optional: Store the fingerprint for future comparisons or trusted devices
  user.fingerprint = fingerprint
  await user.save()

  const token = app.jwt.sign({
    email: user.email,
    fingerprint: fingerprint // 🔐 embed in token
  })

  reply.send({ msg: "Login successful", token })
})

// Signup route
app.post("/api/signup", async (req, reply) => {

  console.log("✅ Signup route triggered") 

  await connectDB()

  const { fullName, userName, email, password } = req.body || {}

  if (!fullName || !userName || !email || !password) {
    return reply.code(400).send({ error: "All fields are required" })
  }

  const exists = await User.findOne({ $or: [{ email }, { userName }] })
  if (exists) return reply.code(409).send({ error: "Email or username already exists" })

  const hash = await bcrypt.hash(password, 10)
  const user = await User.create({ fullName, userName, email, hash })
  const token = app.jwt.sign({ email: user.email })

  reply.send({ msg: "Account created", token })
})

 

app.post("/api/change-password", { preValidation: app.authenticate }, async (req, reply) => {
  console.log("🔐 /api/change-password route hit")

  const { oldPassword, newPassword, fingerprint } = req.body || {}

// ✅ Replace with:
if (!oldPassword || !newPassword) {
  return reply.code(400).send({ error: "All fields are required" })
}


  await connectDB()

  try {
    const user = await User.findOne({ email: req.user.email })

    if (!user) return reply.code(404).send({ error: "User not found" })

    if (user.fingerprint !== fingerprint) {
      return reply.code(403).send({ error: "Fingerprint mismatch" })
    }

    const match = await bcrypt.compare(oldPassword, user.hash)
    if (!match) return reply.code(401).send({ error: "Incorrect current password" })

    const hash = await bcrypt.hash(newPassword, 10)
    user.hash = hash
    await user.save()

    reply.send({ msg: "Password updated successfully" })
  } catch (err) {
    console.error("❌ Change password error:", err)
    reply.code(500).send({ error: "Server error while changing password" })
  }
})

app.get("/api/check-username", async (req, reply) => {
  await connectDB()
  const { userName } = req.query
  if (!userName) return reply.code(400).send({ error: "Missing username" })

  const exists = await User.exists({ userName })
  reply.send({ available: !exists })
}) 

app.get("/api/profile", { preValidation: app.authenticate }, async (req, reply) => {
  console.log("📍 /api/profile route hit")

  if (!req.user || !req.user.email) {
    console.warn("⚠️ Missing user or email after jwtVerify:", req.user)
    return reply.code(401).send({ error: "Unauthorized access" })
  }

  await connectDB()

  try {
    const user = await User.findOne({ email: req.user.email }, "-hash")
    if (!user) {
      return reply.code(404).send({ error: "User not found" })
    }

    reply.send({ user })
  } catch (err) {
    console.error("❌ DB error:", err)
    reply.code(500).send({ error: "Server error while retrieving profile" })
  }
})

if (!process.env.VERCEL) {
  process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
}


const transporter = nodemailer.createTransport({
  service: "gmail", // or SMTP config
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASS,
  },
})

app.post("/api/request-password-reset", async (req, reply) => {
  const { email } = req.body || {}
  const lang = req.headers["x-lang"] || "en"  // detect user language

  if (!email) return reply.code(400).send({ error: "Email required" })

  await connectDB()
  const user = await User.findOne({ email })
  if (!user) return reply.code(404).send({ error: "Email not found" })

  const resetCode = Math.floor(100000 + Math.random() * 900000).toString()
  const expiresAt = Date.now() + 15 * 60 * 1000 // valid for 15 minutes

  user.resetCode = resetCode
  user.resetExpires = expiresAt
  await user.save()

  const url = `http://localhost:3000/reset/?code=${encodeURIComponent(resetCode)}&email=${encodeURIComponent(email)}`

  const subject = lang === "id" ? "Atur Ulang Kata Sandi Anda" : "Reset Your Password"
  const html = lang === "id"
    ? `<p>Berikut adalah kode atur ulang kata sandi Anda: <b>${resetCode}</b></p><p>Atau klik <a href="${url}">tautan ini</a> untuk membuka formulir atur ulang.</p>`
    : `<p>Here is your password reset code: <b>${resetCode}</b></p><p>Or click <a href="${url}">this link</a> to open the reset form.</p>`

  await transporter.sendMail({
    to: email,
    subject,
    html,
    from: `No-Reply <${process.env.EMAIL_USER}>`,
  })

  reply.send({ msg: "Reset instructions sent" })
})

 
export default async function handler(req, res) {
  console.log("🔍 Fastify sees URL:", req.url)
  await app.ready()
 
  app.server.emit("request", req, res)
}
